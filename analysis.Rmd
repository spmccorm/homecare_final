---
title: "Data Analysis and Visualization"
author: "Team5"
date: "May 6, 2018"
output: word_document
---


## Calculating Lifetime Value of Customers and Caregivers
```{r setup}
library(dplyr)
library(ggplot2)
library(geosphere)

shifts = read.csv("shifts.csv")

# This webside explains the calculation of the haversine distance
    #https://andrew.hedges.name/experiments/haversine/
"Earth_R=3961
dlon = shifts$customerlon - shifts$employeelon 
dlat = shifts$customerlat - shifts$employeelat 
a = (sin(dlat/2))^2 + cos(shifts$employeelat) * cos(shifts$customerlat) * (sin(dlon/2))^2 
c = 2 * atan2( sqrt(a), sqrt(1-a) ) 
d = Earth_R * c #where Earth_R is the radius of the Earth"

shifts = shifts %>% 
  mutate(Distance = distHaversine(p1 = cbind(shifts$employeelon,shifts$employeelat),                                  p2=cbind(shifts$customerlon,shifts$customerlat))*0.000621371) %>%
  filter(Distance < 100)

cgdistance = shifts %>%
  group_by(EmployeeKey) %>%
  summarise(avgdist = mean(Distance))

shifts = shifts %>%
  left_join(x=shifts, y=cgdistance, by= "EmployeeKey")

cgLTV=shifts %>%
  group_by(EmployeeKey) %>%
  summarise(cgtotalvalue=sum(Revenue))

shifts = shifts %>%
  left_join(x=shifts, y=cgLTV, by="EmployeeKey")

customerLTV= shifts %>%
  group_by(CustomerKey) %>%
  summarise(custotalvalue=sum(Revenue))

shifts = shifts %>%
  left_join(x=shifts, y=customerLTV, by="CustomerKey")

#average bill and pay rate by location
#proportion of hours that are OT "laborcostpayOThours"


```
